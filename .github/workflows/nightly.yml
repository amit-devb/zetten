name: Nightly Build

on:
  push:
    branches:
      - main

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nightly:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install maturin
        run: pip install maturin tomlkit

      # ðŸ”‘ Dynamically compute nightly version
      - name: Set nightly version
        run: |
          python << 'EOF'
          from datetime import date
          import tomlkit
          import re
          import os

          # 1. Update pyproject.toml
          py_path = "pyproject.toml"
          py_data = tomlkit.parse(open(py_path).read())

          base_version = py_data["project"]["version"]
          base_version = base_version.split(".dev")[0]

          today = date.today().strftime("%Y%m%d")
          run_num = os.environ.get("GITHUB_RUN_NUMBER", "1")
          
          # Python follows PEP 440: 1.3.0.dev2026021042 (Date + Run Num)
          nightly_version_py = f"{base_version}.dev{today}{run_num}"
          # Cargo follows SemVer: 1.3.0-dev2026021042 (must start with hyphen for pre-release)
          nightly_version_cargo = f"{base_version}-dev{today}{run_num}"

          py_data["project"]["version"] = nightly_version_py

          with open(py_path, "w") as f:
              f.write(tomlkit.dumps(py_data))

          print(f"Updated pyproject.toml to {nightly_version_py}")

          # 2. Update Cargo.toml
          cargo_path = "Cargo.toml"
          with open(cargo_path, "r") as f:
              cargo_content = f.read()
          
          # Use regex to replace version = "..." inside [package]
          new_cargo_content = re.sub(
              r'^version = ".*"$', 
              f'version = "{nightly_version_cargo}"', 
              cargo_content, 
              count=1, 
              flags=re.MULTILINE
          )

          with open(cargo_path, "w") as f:
              f.write(new_cargo_content)

          print(f"Updated Cargo.toml to {nightly_version_cargo}")
          
          # 3. Output for shared use (using Python version as main identifier)
          print(f"::set-output name=version::{nightly_version_py}") # Support older runners if needed
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              print(f"version={nightly_version_py}", file=fh)
          EOF

      - name: Build wheels
        run: maturin build --release

      - name: Publish to TestPyPI
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
        run: |
          maturin upload \
            --skip-existing \
            --repository-url https://test.pypi.org/legacy/ \
            target/wheels/*.whl
