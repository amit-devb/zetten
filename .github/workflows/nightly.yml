name: Nightly Build

on:
  push:
    branches:
      - main

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nightly:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install maturin
        run: pip install maturin tomlkit

      # ðŸ”‘ Dynamically compute nightly version
      - name: Set nightly version
        run: |
          python << 'EOF'
          from datetime import date
          import tomlkit
          import re

          # 1. Update pyproject.toml
          py_path = "pyproject.toml"
          py_data = tomlkit.parse(open(py_path).read())

          base_version = py_data["project"]["version"]
          base_version = base_version.split(".dev")[0]

          today = date.today().strftime("%Y%m%d")
          nightly_version = f"{base_version}.dev{today}"

          py_data["project"]["version"] = nightly_version

          with open(py_path, "w") as f:
              f.write(tomlkit.dumps(py_data))

          print(f"Updated pyproject.toml to {nightly_version}")

          # 2. Update Cargo.toml
          cargo_path = "Cargo.toml"
          with open(cargo_path, "r") as f:
              cargo_content = f.read()
          
          # Use regex to replace version = "..." inside [package]
          # This is safer than simple replace, but we assume standard Cargo.toml structure
          # "version = ..." usually appears early.
          new_cargo_content = re.sub(
              r'^version = ".*"$', 
              f'version = "{nightly_version}"', 
              cargo_content, 
              count=1, 
              flags=re.MULTILINE
          )

          with open(cargo_path, "w") as f:
              f.write(new_cargo_content)

          print(f"Updated Cargo.toml to {nightly_version}")
          
          # 3. Output for shared use
          print(f"::set-output name=version::{nightly_version}")
          EOF

      - name: Build wheels
        run: maturin build --release

      - name: Publish to TestPyPI
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
        run: |
          maturin upload \
            --repository-url https://test.pypi.org/legacy/ \
            target/wheels/*.whl
